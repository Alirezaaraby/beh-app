{% extends 'dashboard/base.html'%}
{%load static%}
{% block style %}
<style>
    .dropzone {
        border: dashed 4px #ddd !important;
        background-color: #f2f6fc;
        border-radius: 15px;
    }

    .dropzone .dropzone-container {
        padding: 2rem 0;
        width: 100%;
        height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #8c96a8;
        z-index: 20;
    }

    .dropzone .file-input {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        visibility: hidden;
        cursor: pointer;
    }

    .file-icon {
        font-size: 60px;
    }

    .hr-sect {
        display: flex;
        flex-basis: 100%;
        align-items: center;
        margin: 8px 0px;
    }

    .hr-sect:before,
    .hr-sect:after {
        content: "";
        flex-grow: 1;
        background: #ddd;
        height: 1px;
        font-size: 0px;
        line-height: 0px;
        margin: 0px 8px;
    }

    .messages {
        list-style-type: none;
        padding: 0;
    }

    .messages .error {
        color: red;
    }

    .messages .success {
        color: green;
    }
</style>
{%endblock%}

{% block content %}
<div class="container">
    <div class="shadow p-3 mb-5 bg-body rounded">ارزیابی روزانه جدید</div>

    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% endif %} alert-dismissible fade show" role="alert">
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            {{ message }}
        </div>
        {% endfor %}
    </ul>
    {% endif %}

    <div class="row g-3">
        <div class="col-md-5 col-lg-4 order-md-last">
            <div class="bg-white p-5 rounded shadow-sm border">
                <p>تصویر</p>
                <div class="dropzone d-block">
                    <label for="files" class="dropzone-container">
                        <div class="file-icon"><i class="fa-solid fa-file-circle-plus text-primary"></i></div>
                        <div class="text-center pt-3 px-5">
                            <p class="w-80 h5 text-dark fw-bold">انتخاب تصویر</p>
                        </div>
                    </label>
                    <input id="files" name="files[]" type="file" class="file-input" />
                </div>

                <button type="button" class="btn btn-outline-primary w-100 mt-2">ذخیره</button>

            </div>

        </div>

        <div class="col-md-7 col-lg-8">
            <form class="needs-validation" novalidate="" action="{% url 'daily-evaluation-create'%}" id="mainForm"
                data-indicators-url="{% url 'ajax-load-indicator-items' %}"
                data-indicator-range-url="{% url 'ajax-load-indicator-item-range' %}" method="POST">
                {%csrf_token%}
                <div class="row g-3">

                    <div class="col-md-12">
                        <label for="personnel" class="form-label">ارزیابی شونده</label>
                        <input class="form-control" id="personnel" required="" name="pid" required>
                    </div>

                    <div class="col-md-12">
                        <label for="in_id" class="form-label">نوع شاخص</label>
                        <select class="form-select" id="in_id" name="in_id" required>
                            <option value="">انتخاب کنید</option>
                            {% for in in indicators %}
                            <option value="{{in.id}}">{{in.item_type}}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-12">
                        <label for="it_id" class="form-label">شاخص</label>
                        <select class="form-select" id="it_id" name="it_id" required>
                            <option value="">---------</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="score" class="form-label">امتیاز</label>
                        <input type="number" class="form-control" id="score" min="1" placeholder="" value=""
                            name="score" required>
                    </div>

                    <div class="col-md-6">
                        <label for="record_id" class="form-label">کد پرسنلی ثبت کننده</label>
                        <input type="text" class="form-control" id="record_id" placeholder="" value="" name="record_id"
                            required>
                    </div>
                    <div class="col-md-6">
                        <label for="occure_date" class="form-label">تاریخ وقوع</label>
                        <input class="form-control" id="occure_date" placeholder="" value="" name="occure_date" required
                            data-jdp>
                    </div>
                    <div class="col-md-6">
                        <label for="occure_time" class="form-label">زمان وقوع</label>
                        <input type="text" class="form-control" id="occure_time" placeholder="" value=""
                            name="occure_time" required>
                    </div>
                    <div class="col-md-12">
                        <label for="forecastEffectTime" class="form-label">پیش بینی زمان تاثیر</label>
                        <select class="form-select" id="forecastEffectTime" name="forecast_effect_time" required>
                            <option value="">انتخاب کنید</option>

                            <option value="1">فروردین</option>
                            <option value="2">اردیبهشت</option>
                            <option value="3">خرداد</option>
                            <option value="4">تیر</option>
                            <option value="5">مرداد</option>
                            <option value="6">شهریور</option>
                            <option value="7">مهر</option>
                            <option value="8">آبان</option>
                            <option value="9">آذر</option>
                            <option value="10">دی</option>
                            <option value="11">بهمن</option>
                            <option value="12">اسفند</option>
                        </select>
                    </div>

                    <div class="col-md-12">
                        <label for="country" class="form-label">زمان تاثر واقعی</label>
                        <select class="form-select" id="country" name="real_effect_time" required>
                            <option value="">انتخاب کنید</option>
                            <option value="1">فروردین</option>
                            <option value="2">اردیبهشت</option>
                            <option value="3">خرداد</option>
                            <option value="4">تیر</option>
                            <option value="5">مرداد</option>
                            <option value="6">شهریور</option>
                            <option value="7">مهر</option>
                            <option value="8">آبان</option>
                            <option value="9">آذر</option>
                            <option value="10">دی</option>
                            <option value="11">بهمن</option>
                            <option value="12">اسفند</option>
                        </select>
                    </div>

                    <div class="col-md-12">
                        <label for="description" class="form-label">مصداق</label>
                        <textarea id="description" class="form-control" name="body"></textarea>
                    </div>
                </div>

                <button class="w-100 btn btn-primary btn-lg mt-5 mb-5" type="submit">ذخیره</button>

            </form>
        </div>
    </div>
</div>

{%block script%}

<script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
<script>
    $("#in_id").change(function () {
        const url = $("#mainForm").attr("data-indicators-url");
        const indicatorsId = $(this).val();
        $.ajax({
            url: url,
            data: {
                'in_id': indicatorsId
            },
            success: function (data) {
                let html_data = '<option value="">---------</option>';
                data.forEach(function (indicator) {
                    html_data += `<option value="${indicator.id}">${indicator.item}</option>`;
                });
                $("#it_id").html(html_data);
            }
        });
    });
    $("#it_id").change(function () {
        const url = $("#mainForm").attr("data-indicator-range-url");
        const indicatorId = $(this).val();
        $.ajax({
            url: url,
            data: {
                'it_id': indicatorId
            },
            success: function (data) {
                if (data.length > 0) {
                    const item = data[0];
                    const minEffect = item.min_effect;
                    const maxEffect = item.max_effect;
                    const defaultEffect = item.default_effect;

                    $("#score").attr("min", minEffect);
                    $("#score").attr("max", maxEffect);
                    $("#score").val(defaultEffect);
                }
            },
            error: function (xhr, status, error) {
                console.error('AJAX Error:', status, error);
            }
        });
    });

    jalaliDatepicker.startWatch();
    
    $(function () {
            $("#personnel").autocomplete({
                source: "{% url 'autocomplete' %}"
            });
        });
</script>

{%endblock%}
{%endblock%}